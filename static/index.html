<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #d4d0c8;
      font-family: "Roboto", Arial, sans-serif;
      font-size: 11px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow: auto;
    }

    .desktop {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    /* Windows 95 window — shared */
    .window {
      background: #c0c0c0;
      border-top: 2px solid #ffffff;
      border-left: 2px solid #ffffff;
      border-right: 2px solid #808080;
      border-bottom: 2px solid #808080;
      box-shadow: 2px 2px 0 #000;
      display: flex;
      flex-direction: column;
    }

    .window.chat  { width: 680px; }
    .window.info  { width: 220px; }

    /* Title bar */
    .title-bar {
      background: linear-gradient(to right, #000080, #1084d0);
      color: #fff;
      padding: 3px 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }

    .title-bar-text {
      font-weight: 700;
      font-size: 11px;
      letter-spacing: 0.3px;
    }

    .title-bar-controls {
      display: flex;
      gap: 2px;
    }

    .title-btn {
      width: 16px;
      height: 14px;
      background: #c0c0c0;
      border-top: 1px solid #fff;
      border-left: 1px solid #fff;
      border-right: 1px solid #404040;
      border-bottom: 1px solid #404040;
      font-size: 9px;
      line-height: 12px;
      text-align: center;
      color: #000;
      cursor: pointer;
    }

    .title-btn:active {
      border-top: 1px solid #404040;
      border-left: 1px solid #404040;
      border-right: 1px solid #fff;
      border-bottom: 1px solid #fff;
    }

    /* Window body */
    .window-body {
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* Sunken panel for conversation */
    .conversation-panel {
      border-top: 2px solid #808080;
      border-left: 2px solid #808080;
      border-right: 2px solid #fff;
      border-bottom: 2px solid #fff;
      background: #fff;
      height: 340px;
      overflow-y: auto;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-width: 100%;
    }

    .message-label {
      font-weight: 700;
      font-size: 10px;
      color: #000080;
    }

    .message.agent .message-label { color: #800000; }

    .message-text {
      background: #f0f0f0;
      border-top: 1px solid #808080;
      border-left: 1px solid #808080;
      border-right: 1px solid #fff;
      border-bottom: 1px solid #fff;
      padding: 4px 6px;
      word-break: break-word;
      line-height: 1.5;
    }

    .message.user  .message-text,
    .message.error .message-text { white-space: pre-wrap; }

    .message.user  .message-text { background: #dde5f5; }
    .message.error .message-label { color: #cc0000; }
    .message.error .message-text  { background: #fff0f0; color: #cc0000; }

    /* Markdown content styles */
    .message-text p          { margin: 0 0 6px; }
    .message-text p:last-child { margin-bottom: 0; }
    .message-text ul,
    .message-text ol         { padding-left: 18px; margin: 4px 0 6px; }
    .message-text li          { margin-bottom: 2px; }
    .message-text strong      { font-weight: 700; }
    .message-text em          { font-style: italic; }
    .message-text code        { background: #e8e8e8; padding: 1px 3px; font-family: monospace; font-size: 10px; }
    .message-text pre         { background: #e8e8e8; padding: 6px; overflow-x: auto; margin: 4px 0; }
    .message-text pre code    { background: none; padding: 0; }

    .message.thinking .message-label { color: #b08080; }
    .message.thinking .message-text  { color: #aaa; font-style: italic; background: #f8f8f8; }

    /* Input area */
    .input-panel {
      border-top: 2px solid #808080;
      border-left: 2px solid #808080;
      border-right: 2px solid #fff;
      border-bottom: 2px solid #fff;
      background: #fff;
    }

    textarea {
      width: 100%;
      border: none;
      outline: none;
      resize: none;
      font-family: "Roboto", Arial, sans-serif;
      font-size: 11px;
      padding: 4px 6px;
      background: transparent;
      line-height: 1.5;
    }

    /* Controls row */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .label { white-space: nowrap; color: #000; }

    input[type="text"] {
      flex: 1;
      min-width: 0;
      border-top: 2px solid #808080;
      border-left: 2px solid #808080;
      border-right: 2px solid #fff;
      border-bottom: 2px solid #fff;
      padding: 2px 4px;
      font-family: "Roboto", Arial, sans-serif;
      font-size: 11px;
      background: #fff;
      outline: none;
    }

    /* Win95 button */
    button {
      background: #c0c0c0;
      border-top: 2px solid #fff;
      border-left: 2px solid #fff;
      border-right: 2px solid #404040;
      border-bottom: 2px solid #404040;
      padding: 3px 14px;
      font-family: "Roboto", Arial, sans-serif;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 60px;
    }

    button:active:not(:disabled) {
      border-top: 2px solid #404040;
      border-left: 2px solid #404040;
      border-right: 2px solid #fff;
      border-bottom: 2px solid #fff;
      padding: 4px 13px 2px 15px;
    }

    button:disabled { color: #808080; cursor: default; }

    /* Separator */
    .separator {
      border: none;
      border-top: 1px solid #808080;
      border-bottom: 1px solid #fff;
      margin: 2px 0;
    }

    /* Status bar */
    .status-bar {
      border-top: 1px solid #808080;
      padding: 3px 8px;
      display: flex;
      gap: 8px;
      color: #000;
      font-size: 10px;
    }

    .status-segment {
      border-top: 1px solid #808080;
      border-left: 1px solid #808080;
      border-right: 1px solid #fff;
      border-bottom: 1px solid #fff;
      padding: 1px 6px;
      display: flex;
      gap: 4px;
    }

    .status-label { color: #404040; }

    .status-value {
      color: #000080;
      font-weight: 700;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Info panel */
    .info-body {
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .info-section-title {
      font-weight: 700;
      font-size: 10px;
      color: #000080;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .info-sunken {
      border-top: 2px solid #808080;
      border-left: 2px solid #808080;
      border-right: 2px solid #fff;
      border-bottom: 2px solid #fff;
      background: #fff;
      padding: 5px 6px;
      line-height: 1.6;
      color: #111;
      overflow-wrap: break-word;
      overflow: hidden;
    }

    .info-sunken ul {
      padding-left: 14px;
    }

    .info-sunken li {
      margin-bottom: 2px;
    }
  </style>
</head>
<body>

<div class="desktop">

  <!-- Info panel -->
  <div class="window info">
    <div class="title-bar">
      <span class="title-bar-text">About This Agent</span>
      <div class="title-bar-controls">
        <div class="title-btn">?</div>
      </div>
    </div>
    <div class="info-body">

      <div>
        <div class="info-section-title">What it does</div>
        <div class="info-sunken">
          A document assistant that reads, summarizes, and creates Word documents (.docx) on your behalf using multi-turn conversation.
        </div>
      </div>

      <div>
        <div class="info-section-title">Reads from</div>
        <div class="info-sunken">
          <ul id="infoReads"><li>—</li></ul>
        </div>
      </div>

      <div>
        <div class="info-section-title">Writes to</div>
        <div class="info-sunken">
          <ul id="infoWrites"><li>—</li></ul>
        </div>
      </div>

      <div>
        <div class="info-section-title">Try asking</div>
        <div class="info-sunken">
          <ul>
            <li>Make me a report on...</li>
            <li>Summarize the doc at /Volumes/...</li>
            <li>List all docs in my volume</li>
            <li>Rewrite that with a formal tone</li>
          </ul>
        </div>
      </div>

    </div>
  </div>

  <!-- Chat window -->
  <div class="window chat">
    <div class="title-bar">
      <span class="title-bar-text">Agent Chat</span>
      <div class="title-bar-controls">
        <div class="title-btn">_</div>
        <div class="title-btn">□</div>
        <div class="title-btn">✕</div>
      </div>
    </div>

    <div class="window-body">
      <div class="conversation-panel" id="conversation"></div>

      <div class="input-panel">
        <textarea id="userInput" rows="3" placeholder="Type your message here... (Ctrl+Enter to send)"></textarea>
      </div>

      <div class="controls-row">
        <span class="label">Auth Token (optional)</span>
        <input type="text" id="authToken" placeholder="Bearer token..." />
        <button id="stopBtn" onclick="stopRequest()" disabled>Stop</button>
        <button id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <hr class="separator">

    <div class="status-bar">
      <div class="status-segment">
        <span class="status-label">Session:</span>
        <span class="status-value" id="statusSession">—</span>
      </div>
      <div class="status-segment">
        <span class="status-label">Output:</span>
        <span class="status-value" id="statusOutput">—</span>
      </div>
      <div class="status-segment">
        <span class="status-label">Status:</span>
        <span class="status-value" id="statusReady">Ready</span>
      </div>
    </div>
  </div>

</div><!-- .desktop -->

<script>
  function uuidv4() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  const conversationId = uuidv4();
  const conversation  = document.getElementById('conversation');
  const sendBtn       = document.getElementById('sendBtn');
  const stopBtn       = document.getElementById('stopBtn');
  const userInput     = document.getElementById('userInput');
  const authToken     = document.getElementById('authToken');
  const statusSession = document.getElementById('statusSession');
  const statusOutput  = document.getElementById('statusOutput');
  const statusReady   = document.getElementById('statusReady');

  let currentController = null;

  function stopRequest() {
    if (currentController) {
      currentController.abort();
      currentController = null;
    }
  }

  let workspaceHost = '';
  fetch('/api/config')
    .then(r => r.json())
    .then(d => {
      workspaceHost = d.host || '';
      const vol = d.volume_path || '';
      if (vol) {
        const li = `<li>${vol}</li>`;
        document.getElementById('infoReads').innerHTML  = li;
        document.getElementById('infoWrites').innerHTML = li;
      }
    })
    .catch(() => {});

  userInput.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); sendMessage(); }
  });

  // Build Databricks volume explorer URL from a /Volumes/... path
  function databricksVolumeUrl(path) {
    const base = workspaceHost;
    if (!base) return null;
    const parts = path.split('/').filter(Boolean);
    if (parts.length < 4) return null;
    const [, catalog, schema, volume] = parts;
    const dirPath = path.slice(0, path.lastIndexOf('/') + 1);
    return base
      + '/explore/data/volumes/' + catalog + '/' + schema + '/' + volume
      + '?volumePath=' + encodeURIComponent(dirPath);
  }

  // Render markdown then linkify /Volumes/... paths in the resulting text nodes
  function renderAgentText(container, text) {
    container.innerHTML = marked.parse(text);

    const pathPattern = /(\/Volumes\/[^\s,;'")\]]+)/g;
    const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
    const textNodes = [];
    let node;
    while ((node = walker.nextNode())) textNodes.push(node);

    for (const textNode of textNodes) {
      const val = textNode.nodeValue;
      if (!val.includes('/Volumes/')) continue;

      const frag = document.createDocumentFragment();
      let last = 0, match;
      pathPattern.lastIndex = 0;
      while ((match = pathPattern.exec(val)) !== null) {
        if (match.index > last) frag.appendChild(document.createTextNode(val.slice(last, match.index)));
        const a = document.createElement('a');
        const href = databricksVolumeUrl(match[1]);
        a.href = href ?? match[1];
        a.textContent = match[1];
        a.title = 'Open in Databricks';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.style.cssText = 'color:#000080;text-decoration:underline;';
        frag.appendChild(a);
        last = match.index + match[0].length;
      }
      if (last < val.length) frag.appendChild(document.createTextNode(val.slice(last)));
      textNode.parentNode.replaceChild(frag, textNode);
    }
  }

  function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = 'message ' + role;

    const label = document.createElement('div');
    label.className = 'message-label';
    label.textContent = role === 'user' ? 'You:' : role === 'agent' ? 'Agent:' : 'Error:';

    const body = document.createElement('div');
    body.className = 'message-text';
    if (role === 'agent') {
      renderAgentText(body, text);
    } else {
      body.textContent = text;
    }

    div.appendChild(label);
    div.appendChild(body);
    conversation.appendChild(div);
    conversation.scrollTop = conversation.scrollHeight;
  }

  const thinkingPhrases = [
    'Scheming',
    'Ruminating',
    'Exploring the seven seas',
    'Consulting the oracle',
    'Staring into the void',
    'Sharpening quill',
    'Bribing the database',
    'Untangling spaghetti',
    'Summoning the spreadsheet spirits',
    'Definitely not procrastinating',
    'Asking a wizard',
    'Rearranging deck chairs',
    'Negotiating with the CPU',
    'Brewing a fresh pot of inference',
    'Petting the GPU',
  ];

  let dotInterval    = null;
  let phraseInterval = null;

  function startThinking() {
    const div = document.createElement('div');
    div.className = 'message agent thinking';
    div.id = 'thinkingMsg';

    const label = document.createElement('div');
    label.className = 'message-label';
    label.textContent = 'Agent:';

    const body = document.createElement('div');
    body.className = 'message-text';

    div.appendChild(label);
    div.appendChild(body);
    conversation.appendChild(div);
    conversation.scrollTop = conversation.scrollHeight;

    let phraseIdx = Math.floor(Math.random() * thinkingPhrases.length);
    let dots = 1;
    body.textContent = thinkingPhrases[phraseIdx] + '.';

    // Dots animate at 500ms
    dotInterval = setInterval(() => {
      dots = (dots % 3) + 1;
      body.textContent = thinkingPhrases[phraseIdx] + '.'.repeat(dots);
      conversation.scrollTop = conversation.scrollHeight;
    }, 500);

    // Phrase changes every 4s, never repeating back-to-back
    phraseInterval = setInterval(() => {
      let next;
      do { next = Math.floor(Math.random() * thinkingPhrases.length); }
      while (next === phraseIdx && thinkingPhrases.length > 1);
      phraseIdx = next;
      dots = 1;
      body.textContent = thinkingPhrases[phraseIdx] + '.';
    }, 4000);
  }

  function stopThinking(finalText) {
    clearInterval(dotInterval);
    clearInterval(phraseInterval);
    dotInterval = phraseInterval = null;
    const thinkingMsg = document.getElementById('thinkingMsg');
    if (thinkingMsg) thinkingMsg.remove();
    statusReady.textContent = finalText;
  }

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    sendBtn.disabled = true;
    stopBtn.disabled = false;
    userInput.disabled = true;
    statusReady.textContent = 'Working...';

    appendMessage('user', text);
    userInput.value = '';
    startThinking();

    const headers = { 'Content-Type': 'application/json' };
    const token = authToken.value.trim();
    if (token) headers['Authorization'] = 'Bearer ' + token;

    currentController = new AbortController();

    // agentMsgBody is created on the first streamed token
    let agentMsgBody = null;
    let agentText = '';

    try {
      const response = await fetch('/invocations', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          input: [{ role: 'user', content: text }],
          custom_inputs: { conversation_id: conversationId },
          stream: true,
        }),
        signal: currentController.signal,
      });

      if (!response.ok) {
        let errText;
        try { errText = await response.text(); } catch(_) { errText = response.statusText; }
        stopThinking('Error');
        appendMessage('error', 'HTTP ' + response.status + ': ' + errText);
        return;
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        for (const line of chunk.split('\n')) {
          if (!line.startsWith('data: ')) continue;
          const data = line.slice(6).trim();
          if (!data || data === '[DONE]') continue;

          let event;
          try { event = JSON.parse(data); } catch(_) { continue; }

          if (event.type === 'response.output_text.delta' && event.delta) {
            // First token: swap thinking bubble for live agent message
            if (!agentMsgBody) {
              stopThinking('Working...');
              const div = document.createElement('div');
              div.className = 'message agent';
              const lbl = document.createElement('div');
              lbl.className = 'message-label';
              lbl.textContent = 'Agent:';
              agentMsgBody = document.createElement('div');
              agentMsgBody.className = 'message-text';
              div.appendChild(lbl);
              div.appendChild(agentMsgBody);
              conversation.appendChild(div);
            }
            agentText += event.delta;
            renderAgentText(agentMsgBody, agentText);
            conversation.scrollTop = conversation.scrollHeight;

          } else if (event.type === 'response.output_item.done') {
            const customOutputs = event.item?.custom_outputs ?? {};
            if (customOutputs.session_id)  statusSession.textContent = customOutputs.session_id;
            if (customOutputs.output_path) statusOutput.textContent  = customOutputs.output_path;

            // Fallback if no delta events arrived (e.g. non-streaming endpoint)
            if (!agentMsgBody) {
              const itemText = event.item?.content?.[0]?.text ?? '';
              if (itemText) {
                stopThinking('Ready');
                appendMessage('agent', itemText);
                agentText = itemText;
              }
            }
          }
        }
      }

      stopThinking('Ready');

    } catch (err) {
      if (err.name === 'AbortError') {
        stopThinking('Stopped');
        appendMessage('error', 'Request stopped by user.');
      } else {
        stopThinking('Error');
        appendMessage('error', 'Request failed: ' + err.message);
      }
    } finally {
      currentController = null;
      sendBtn.disabled = false;
      stopBtn.disabled = true;
      userInput.disabled = false;
      userInput.focus();
    }
  }
</script>
</body>
</html>
